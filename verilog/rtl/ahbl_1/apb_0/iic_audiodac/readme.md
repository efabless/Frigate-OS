# IIC_AUDIODAC

Delta-sigma audio DAC (16b, 48kHz)
## The wrapped IP


 APB, AHBL, and Wishbone wrappers, generated by the [BusWrap](https://github.com/efabless/BusWrap/tree/main) `bus_wrap.py` utility, are provided. All wrappers provide the same programmer's interface as outlined in the following sections.

### Wrapped IP System Integration

Based on your use case, use one of the provided wrappers or create a wrapper for your system bus type. For an example of how to integrate the APB wrapper:
```verilog
iic_audiodac_APB INST (
        `TB_APB_SLAVE_CONN,
        .vccd1(vccd1)
        .vssd1(vssd1)
        .ds_o(ds_o)
        .ds_n_o(ds_n_o)
);
```
> **_NOTE:_** `TB_APB_SLAVE_CONN is a convenient macro provided by [BusWrap](https://github.com/efabless/BusWrap/tree/main).

## Implementation example  

The following table is the result for implementing the IIC_AUDIODAC IP with different wrappers using Sky130 PDK and [OpenLane2](https://github.com/efabless/openlane2) flow.
|Module | Number of cells | Max. freq |
|---|---|---|
|IIC_AUDIODAC|None| None |
|iic_audiodac_APB|None|None|
|iic_audiodac_AHBL|None|None|
|IIC_AUDIODAC_WB|None|None|
## The Programmer's Interface


### Registers

|Name|Offset|Reset Value|Access Mode|Description|
|---|---|---|---|---|
|DATA|0000|0x00000000|w|16-bit audio data.|
|FRDY|0004|0x00000000|w|None|
|FACK|0008|0x00000000|r|None|
|CFG|000c|0x00000000|w|Configuration Register.|
|TST_FIFO_LOOP|0010|0x00000000|w|None|
|IM|ff00|0x00000000|w|Interrupt Mask Register; write 1/0 to enable/disable interrupts; check the interrupt flags table for more details|
|RIS|ff08|0x00000000|w|Raw Interrupt Status; reflects the current interrupts status;check the interrupt flags table for more details|
|MIS|ff04|0x00000000|w|Masked Interrupt Status; On a read, this register gives the current masked status value of the corresponding interrupt. A write has no effect; check the interrupt flags table for more details|
|IC|ff0c|0x00000000|w|Interrupt Clear Register; On a write of 1, the corresponding interrupt (both raw interrupt and masked interrupt, if enabled) is cleared; check the interrupt flags table for more details|

### DATA Register [Offset: 0x0, mode: w]

16-bit audio data.
<img src="https://svg.wavedrom.com/{reg:[{name:'DATA', bits:16},{bits: 16}], config: {lanes: 2, hflip: true}} "/>


### FRDY Register [Offset: 0x4, mode: w]

None
<img src="https://svg.wavedrom.com/{reg:[{name:'FRDY', bits:1},{bits: 31}], config: {lanes: 2, hflip: true}} "/>


### FACK Register [Offset: 0x8, mode: r]

None
<img src="https://svg.wavedrom.com/{reg:[{name:'FACK', bits:1},{bits: 31}], config: {lanes: 2, hflip: true}} "/>


### CFG Register [Offset: 0xc, mode: w]

Configuration Register.
<img src="https://svg.wavedrom.com/{reg:[{name:'MODE', bits:1},{name:'VOLUME', bits:4},{name:'OSR', bits:2},{bits: 25}], config: {lanes: 2, hflip: true}} "/>

|bit|field name|width|description|
|---|---|---|---|
|0|MODE|1|0 = 1st, 1 = 2nd order SD-mod|
|1|VOLUME|4|0 = off, 1 = min volume, 15 = max volume|
|5|OSR|2|0 = 32; 1 = 64, 2 = 128, 3 = 256|


### TST_FIFO_LOOP Register [Offset: 0x10, mode: w]

None
<img src="https://svg.wavedrom.com/{reg:[{name:'TST_FIFO_LOOP', bits:1},{bits: 31}], config: {lanes: 2, hflip: true}} "/>


### Interrupt Flags

The wrapped IP provides four registers to deal with interrupts: IM, RIS, MIS and IC. These registers exist for all wrapper types generated by the [BusWrap](https://github.com/efabless/BusWrap/tree/main) `bus_wrap.py` utility. 

Each register has a group of bits for the interrupt sources/flags.
- `IM`: is used to enable/disable interrupt sources.

- `RIS`: has the current interrupt status (interrupt flags) whether they are enabled or disabled.

- `MIS`: is the result of masking (ANDing) RIS by IM.

- `IC`: is used to clear an interrupt flag.


The following are the bit definitions for the interrupt registers:

|Bit|Flag|Width|Description|
|---|---|---|---|
|0|FE|1|FIFO is Empty|
|1|FF|1|FIFO is full|

### The Interface 


#### Ports 

|Port|Direction|Width|Description|
|---|---|---|---|
|vccd1|inout|1|None|
|vssd1|inout|1|None|
|ds_o|output|1|single-bit SD-modulator output|
|ds_n_o|output|1|single-bit SD-modulator inverted output|
|fifo_i|input|16|None|
|fifo_rdy_i|input|1|None|
|fifo_ack_o|output|1|None|
|fifo_full_o|output|1|None|
|fifo_empty_o|output|1|None|
|mode_i|input|1|None|
|volume_i|input|4|None|
|osr_i|input|2|None|
|tst_fifo_loop_i|input|1|None|
## F/W Usage Guidelines:
## Installation:
You can either clone repo or use [IPM](https://github.com/efabless/IPM) which is an open-source IPs Package Manager
* To clone repo:
```git clone https://https://github.com/iic-jku/iic-audiodac-v1```
* To download via IPM , follow installation guides [here](https://github.com/efabless/IPM/blob/main/README.md) then run 
```ipm install IIC_AUDIODAC```
### Run cocotb UVM Testbench:
In IP directory run:
 ```shell
 cd verify/uvm-python/
 ```
 ##### To run testbench for design with APB 
 To run all tests:
 ```shell
 make run_all_tests BUS_TYPE=APB
 ```
 To run a certain test:
 ```shell
 make run_<test_name> BUS_TYPE=APB
 ```
 To run all tests with a tag: 
 ```shell
 make run_all_tests TAG=<new_tag> BUS_TYPE=APB
 ```
 ##### To run testbench for design with APB
 To run all tests:
 ```shell
 make run_all_tests BUS_TYPE=AHB
 ```
 To run a certain test:
 ```shell
 make run_<test_name> BUS_TYPE=AHB
 ```
 To run all tests with a tag: 
 ```shell
 make run_all_tests TAG=<new_tag> BUS_TYPE=AHB
```